---
ms.openlocfilehash: 3e62289181d994a0e786bb53417f576ac1a3059b
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2022
ms.locfileid: "138052492"
---
# <a name="azure-cosmos-db-client-library-for-javascripttypescript"></a>Клиентская библиотека Azure Cosmos DB для JavaScript/TypeScript

[![последняя версия npm](https://img.shields.io/npm/v/%40azure%2Fcosmos/latest.svg)][npm]
[![Статус сборки](https://dev.azure.com/azure-sdk/public/_apis/build/status/js/js%20-%20cosmosdb%20-%20ci?branchName=main)](https://dev.azure.com/azure-sdk/public/_build/latest?definitionId=850&branchName=main)

Azure Cosmos DB — это глобально распределенная многомодельная служба баз данных, которая поддерживает базы данных документов, пар "ключ-значение" и графов, а также базы данных с широкими столбцами. Этот пакет позволяет приложениям JavaScript и Typescript взаимодействовать с базами данных, поддерживающими **API SQL**, и содержащимися в них документами JSON:

- Создание баз данных Cosmos DB и изменение их параметров
- Создание и изменение контейнеров для хранения коллекций документов JSON
- Создание, чтение, обновление и удаление элементов (документов JSON) в контейнерах
- Запрос документов в базе данных с помощью синтаксиса, аналогичного SQL

Основные ссылки:

- [Пакет (npm)][npm]
- [Справочная документация по API](https://docs.microsoft.com/javascript/api/@azure/cosmos/?view=azure-node-lates)
- [Документация по продукту][cosmos_docs]

## <a name="getting-started"></a>Начало работы

### <a name="prerequisites"></a>Предварительные требования

#### <a name="azure-subscription-and-cosmos-db-sql-api-account"></a>Подписка Azure и учетная запись API SQL для Cosmos DB

Для использования этого пакета необходимо иметь [подписку Azure][azure_sub] и [учетную запись Cosmos DB][cosmos_account] (API SQL).

Если вам нужна учетная запись API SQL для Cosmos DB, ее можно создать в службе [Azure Cloud Shell][cloud_shell_bash] с помощью следующей команды Azure CLI:

```Bash
az cosmosdb create --resource-group <resource-group-name> --name <cosmos-database-account-name>
```

Учетную запись также можно создать на [портале Azure](https://portal.azure.com/#create/microsoft.documentdb).

#### <a name="nodejs"></a>Node.js

Этот пакет распространяется через диспетчер [npm][npm], который предустанавливается вместе с [NodeJS](https://nodejs.org/en/). Следует использовать node.js 10 или более поздней версии.

#### <a name="cors"></a>CORS

Чтобы разрабатывать решения для браузеров, необходимо настроить правила [общего доступа к ресурсам независимо от источника (CORS)](https://docs.microsoft.com/azure/cosmos-db/how-to-configure-cross-origin-resource-sharing) для учетной записи Cosmos DB. Следуйте инструкциям в связанном документе, чтобы создать новые правила CORS для Cosmos DB.

### <a name="install-this-package"></a>Установка пакета

```Bash
npm install @azure/cosmos
```

### <a name="get-account-credentials"></a>Получение учетных данных учетной записи

Вам потребуется **конечная точка** и **ключ учетной записи** для Cosmos DB. Их можно узнать на [портале Azure](https://portal.azure.com/#blade/hubsextension/browseresource/resourcetype/microsoft.documentdb%2fdatabaseaccounts) или выполнив фрагмент кода [Azure CLI][azure_cli] ниже. Фрагмент кода отформатирован для оболочки Bash.

```Bash
az cosmosdb show --resource-group <your-resource-group> --name <your-account-name> --query documentEndpoint --output tsv
az cosmosdb keys list --resource-group <your-resource-group> --name <your-account-name> --query documentEndpoint --output tsv
```

### <a name="create-an-instance-of-cosmosclient"></a>Создание экземпляра `CosmosClient`

Взаимодействие с Cosmos DB осуществляется через экземпляр класса [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest)

```js
const { CosmosClient } = require("@azure/cosmos");

const endpoint = "https://your-account.documents.azure.com";
const key = "<database account masterkey>";
const client = new CosmosClient({ endpoint, key });

async function main() {
  // The rest of the README samples are designed to be pasted into this function body
}

main().catch((error) => {
  console.error(error);
});
```

Для простоты мы включили параметры `key` и `endpoint` непосредственно в код, но вы, вероятно, возьмете их из файла, не включенного в систему управления версиями, с помощью проекта, например [dotenv](https://www.npmjs.com/package/dotenv), или загрузите из переменных среды.

В рабочих средах такие секреты, как ключи, должны храниться в [Azure Key Vault](https://azure.microsoft.com/services/key-vault/)

## <a name="key-concepts"></a>Основные понятия

После инициализации [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-lates) можно работать с ресурсами основных типов в Cosmos DB:

- [База данных](https://docs.microsoft.com/javascript/api/@azure/cosmos/database?view=azure-node-latest): Учетная запись Cosmos DB может предоставлять доступ к нескольким базам данных. При создании базы данных задается API, который будет использоваться для работы с документами в ней: SQL, MongoDB, Gremlin, Cassandra или Azure Table. Используйте объект [Database](https://docs.microsoft.com/javascript/api/@azure/cosmos/database?view=azure-node-latest) для управления контейнерами.

- [Контейнер](https://docs.microsoft.com/javascript/api/@azure/cosmos/container?view=azure-node-latest): Контейнер — это набор документов JSON. Создание (вставка), чтение, обновление и удаление элементов в контейнере выполняется с помощью методов объекта [Container](https://docs.microsoft.com/javascript/api/@azure/cosmos/container?view=azure-node-latest).

- [Элемент](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest). Элемент — это документ JSON, хранящийся в контейнере. Каждый элемент должен содержать ключ `id` со значением, которое уникальным образом определяет элемент в контейнере. Если не указать `id`, пакет SDK создаст его автоматически.

Дополнительные сведения об этих ресурсах см. в статье [Работа с базами данных, контейнерами и элементами Azure Cosmos][cosmos_resources].

## <a name="examples"></a>Примеры

В следующих разделах приведено несколько фрагментов кода для наиболее распространенных задач в Cosmos DB.

- [Создание базы данных](#create-a-database)
- [Создание контейнера](#create-a-container)
- [Вставка элементов](#insert-items)
- [Запрос документов](#query-the-database)
- [Чтение элемента](#read-an-item)
- [Удаление элемента](#delete-an-data)

### <a name="create-a-database"></a>Создание базы данных

После проверки подлинности [CosmosClient](https://docs.microsoft.com/javascript/api/@azure/cosmos/cosmosclient?view=azure-node-latest) можно работать с любым ресурсом в учетной записи. Следующий фрагмент кода создает базу данных API SQL.

```js
const { database } = await client.databases.createIfNotExists({ id: "Test Database" });
console.log(database.id);
```

### <a name="create-a-container"></a>Создание контейнера

В этом примере создается контейнер с параметрами по умолчанию

```js
const { container } = await database.containers.createIfNotExists({ id: "Test Database" });
console.log(container.id);
```

### <a name="insert-items"></a>Вставка элементов

Чтобы вставить элементы в контейнер, передайте объект, содержащий данные, в [Items.upsert](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#upsert-t--requestoptions-). Служба Cosmos DB требует, чтобы у каждого элемента был ключ `id`. Если его не указать, пакет SDK создаст `id` автоматически.

В этом примере в контейнер вставляется несколько элементов.

```js
const cities = [
  { id: "1", name: "Olympia", state: "WA", isCapitol: true },
  { id: "2", name: "Redmond", state: "WA", isCapitol: false },
  { id: "3", name: "Chicago", state: "IL", isCapitol: false }
];
for (const city of cities) {
  container.items.create(city);
}
```

### <a name="read-an-item"></a>Чтение элемента

Чтобы прочитать один элемент из контейнера, используйте метод [Item.read](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest#read-requestoptions-). Это менее ресурсоемкая операция, чем использование SQL для запроса`id`.

```js
await container.item("1").read();
```

### <a name="delete-an-item"></a>Удаление элемента

Чтобы удалить элементы из контейнера, используйте метод [Item.delete](https://docs.microsoft.com/javascript/api/@azure/cosmos/item?view=azure-node-latest#delete-requestoptions-).

```js
// Delete the first item returned by the query above
await container.item("1").delete();
```

### <a name="query-the-database"></a>Выполнение запросов к базе данных

База данных Cosmos DB с поддержкой API SQL позволяет выполнять запросы элементов в контейнере с помощью метода [Items.query](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#query-string---sqlqueryspec--feedoptions-), синтаксис которого аналогичен SQL:

```js
const { resources } = await container.items
  .query("SELECT * from c WHERE c.isCapitol = true")
  .fetchAll();
for (const city of resources) {
  console.log(`${city.name}, ${city.state} is a capitol `);
}
```

Выполняйте параметризованные запросы, передавая объект с параметрами и их значениями в метод [Items.query](https://docs.microsoft.com/javascript/api/@azure/cosmos/items?view=azure-node-latest#query-string---sqlqueryspec--feedoptions-):

```js
const { resources } = await container.items
  .query({
    query: "SELECT * from c WHERE c.isCapitol = @isCapitol",
    parameters: [{ name: "@isCapitol", value: true }]
  })
  .fetchAll();
for (const city of resources) {
  console.log(`${city.name}, ${city.state} is a capitol `);
}
```

Дополнительные сведения о запросах к базам данных Cosmos DB с помощью API SQL см. в статье [SQL-запросы к базе данных Azure Cosmos DB][cosmos_sql_queries]".

## <a name="troubleshooting"></a>Устранение неполадок

### <a name="general"></a>Общие сведения

При работе с Cosmos DB ошибки, возвращаемые службой, соответствуют тем же кодам состояния HTTP, которые возвращаются для запросов REST API.

[Коды состояния HTTP для Azure Cosmos DB][cosmos_http_status_codes]

#### <a name="conflicts"></a>Конфликты

Например, при попытке создать элемент с помощью идентификатора `id`, который уже используется в базе данных Cosmos DB, возвращается ошибка `409`, указывающая на наличие конфликта. В следующем фрагменте кода ошибка корректно обрабатывается путем перехвата исключения и отображения дополнительной информации об этой ошибке.

```js
try {
  await containers.items.create({ id: "existing-item-id" });
} catch (error) {
  if (error.code === 409) {
    console.log("There was a conflict with an existing item");
  }
}
```

### <a name="transpiling"></a>Компиляция в код на другом языке

Пакеты Azure SDK поддерживают синтаксис JavaScript ES5 и [версии LTS для Node.js](https://nodejs.org/about/releases/). Если вам нужна поддержка более ранних сред выполнения JavaScript, таких как Internet Explorer или Node 6, потребуется соответствующим образом скомпилировать код пакета SDK в процессе сборки.

### <a name="handle-transient-errors-with-retries"></a>Обработка временных ошибок с помощью повторных вызовов

При работе с Cosmos DB могут возникать временные сбои, вызванные [ограничениями скорости][cosmos_request_units], применяемыми службой, или другие периодические проблемы, такие как отказ сети. Для получения дополнительной информации об обработке этих типов сбоев ознакомьтесь со статьей [Шаблон повторов][azure_pattern_retry] в руководстве по конструктивным шаблонам облачных решений и соответствующим [шаблоном автоматического выключения][azure_pattern_circuit_breaker].

## <a name="next-steps"></a>Дальнейшие действия

### <a name="more-sample-code"></a>Больше примеров кода

[Несколько примеров][cosmos_samples] доступны в репозитории GitHub. В них содержится код для других ситуаций, которые часто возникают при работе с Cosmos DB:

- Операции с базой данных
- Операции с контейнерами
- Операции над элементами
- Настройка индексирования
- Чтение канала изменений контейнера
- Хранимые процедуры
- Изменение параметров пропускной способности базы данных и контейнера
- Операции записи в нескольких регионах

### <a name="additional-documentation"></a>Дополнительная документация

Более подробную документацию по службе Cosmos DB см. в [документации по Azure Cosmos DB][cosmos_docs] на портале docs.microsoft.com.

## <a name="useful-links"></a>Полезные ссылки

- [Вас приветствует Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/community)
- [Быстрый запуск](https://docs.microsoft.com/azure/cosmos-db/sql-api-nodejs-get-started)
- [Руководство](https://docs.microsoft.com/azure/cosmos-db/sql-api-nodejs-application)
- [Примеры](https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/cosmosdb/cosmos/samples)
- [Общие сведения о модели ресурсов службы Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/sql-api-resources)
- [Общие сведения об API SQL службы Azure Cosmos DB](https://docs.microsoft.com/azure/cosmos-db/sql-api-sql-query)
- [Секционирование](https://docs.microsoft.com/azure/cosmos-db/sql-api-partition-data)
- [Документация по API](https://docs.microsoft.com/javascript/api/%40azure/cosmos/?view=azure-node-latest)

## <a name="contributing"></a>Участие

Если вы хотите участвовать в развитии этой библиотеки, ознакомьтесь с [руководством по работе](https://github.com/Azure/azure-sdk-for-js/blob/main/CONTRIBUTING.md), где рассказывается о создании и тестировании кода.

![Просмотры](https://azure-sdk-impressions.azurewebsites.net/api/impressions/azure-sdk-for-js%2Fsdk%2Fcosmosdb%2Fcosmos%2FREADME.png)

<!-- LINKS -->

[azure_cli]: https://docs.microsoft.com/cli/azure
[azure_pattern_circuit_breaker]: https://docs.microsoft.com/azure/architecture/patterns/circuit-breaker
[azure_pattern_retry]: https://docs.microsoft.com/azure/architecture/patterns/retry
[azure_portal]: https://portal.azure.com
[azure_sub]: https://azure.microsoft.com/free/
[cloud_shell]: https://docs.microsoft.com/azure/cloud-shell/overview
[cloud_shell_bash]: https://shell.azure.com/bash
[cosmos_account_create]: https://docs.microsoft.com/azure/cosmos-db/how-to-manage-database-account
[cosmos_account]: https://docs.microsoft.com/azure/cosmos-db/account-overview
[cosmos_container]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-containers
[cosmos_database]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-databases
[cosmos_docs]: https://docs.microsoft.com/azure/cosmos-db/
[cosmos_http_status_codes]: https://docs.microsoft.com/rest/api/cosmos-db/http-status-codes-for-cosmosdb
[cosmos_item]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items#azure-cosmos-items
[cosmos_request_units]: https://docs.microsoft.com/azure/cosmos-db/request-units
[cosmos_resources]: https://docs.microsoft.com/azure/cosmos-db/databases-containers-items
[cosmos_samples]: https://github.com/Azure/azure-sdk-for-js/tree/main/sdk/cosmosdb/cosmos/samples
[cosmos_sql_queries]: https://docs.microsoft.com/azure/cosmos-db/how-to-sql-query
[cosmos_ttl]: https://docs.microsoft.com/azure/cosmos-db/time-to-live
[npm]: https://www.npmjs.com/package/@azure/cosmos
