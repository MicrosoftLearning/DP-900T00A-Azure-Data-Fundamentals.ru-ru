---
ms.openlocfilehash: 4f36d4681facd228c63b48050973040e9785d30f
ms.sourcegitcommit: e739004291428ce83f14b9d49f1e9dfaa3762dde
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/05/2022
ms.locfileid: "138052180"
---

<a name="microsoft-authentication-library-for-javascript-msaljs"></a>Библиотека аутентификации Майкрософт для JavaScript (MSAL.js)
=========================================================

| [Начало работы](https://docs.microsoft.com/azure/active-directory/develop/guidedsetups/active-directory-javascriptspa)| [Документация по AAD](https://aka.ms/aaddevv2) | [Справочник по библиотеке](https://azuread.github.io/microsoft-authentication-library-for-js/ref/modules/_azure_msal.html) | [Поддержка](README.md#community-help-and-support) | [Примеры](https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki/Samples)
| --- | --- | --- | --- | --- |

⚠️⚠️⚠️ Для этой библиотеки больше не выпускаются новые функции, а будут предлагаться только исправления критических ошибок и исправления безопасности. Вместо этой библиотеки во всех новых приложениях следует использовать [@azure/msal-browser](https://www.npmjs.com/package/@azure/msal-browser). ⚠️⚠️⚠️

Библиотека MSAL для JavaScript позволяет клиентским веб-приложениям JavaScript, работающим в веб-браузере, проверять подлинность пользователей с помощью рабочих и учебных учетных записей [Azure AD](https://docs.microsoft.com/azure/active-directory/develop/v2-overview) (AAD), личных учетных записей Майкрософт (MSA) и поставщиков удостоверений в социальных сетях, таких как Facebook, Google, LinkedIn и пр. через службу [Azure AD B2C](https://docs.microsoft.com/azure/active-directory-b2c/active-directory-b2c-overview#identity-providers). Она также позволяет приложению получать маркеры для доступа к [службам Microsoft Cloud](https://www.microsoft.com/enterprise), таким как [Microsoft Graph](https://graph.microsoft.io).

[![версия npm](https://img.shields.io/npm/v/msal.svg?style=flat)](https://www.npmjs.com/package/msal)
[![версия npm](https://img.shields.io/npm/dm/msal.svg)](https://nodei.co/npm/msal/)
[![codecov](https://codecov.io/gh/AzureAD/microsoft-authentication-library-for-js/branch/dev/graph/badge.svg?flag=msal-core)](https://codecov.io/gh/AzureAD/microsoft-authentication-library-for-js)

## <a name="installation"></a>Установка

### <a name="via-npm"></a>Через NPM

    npm install msal

## <a name="via-cdn"></a>Через CDN

<!-- CDN_LATEST -->
```html
<script type="text/javascript" src="https://alcdn.msauth.net/lib/1.4.11/js/msal.min.js"></script>
```

[Подробные сведения и рекомендации](https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-core/docs/cdn.md) по использованию CDN доступны в нашей документации.

## <a name="what-to-expect-from-this-library"></a>Что предлагает эта библиотека
MSAL в Javascript — это коллекция библиотек. `msal-core` или просто `msal` — это не зависящая от платформы базовая библиотека. После стабилизации ядра 1.x+ мы собираемся представить библиотеку `msal-angular` с последними улучшениями версии 1.x.  Мы планируем прекратить поддержку `msal-angularjs`, так как вместо Angular 1x все большее число пользователей отдает предпочтение Angular 2+. Когда наши текущие библиотеки будут приведены в соответствие со стандартами, мы начнем реализовывать запросы на новые функции для новых платформ, таких как `react` и `node.js`.

Мы будем держать тесный контакт с сообществом и принимать во внимание его мнение. Мы хотим реализовать ежемесячную публикацию вспомогательных версий и представлять исправления по мере необходимости.  Мы хотим постоянно повышать уровень взаимодействия, планирования и детализации.

Узнать, над чем мы работаем и что планируем, можно в нашей [дорожной карте](https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki#roadmap).

## <a name="oauth-20-and-the-implicit-flow"></a>OAuth 2.0 и неявный поток

Библиотека MSAL реализует [поток неявного предоставления разрешений](https://docs.microsoft.com/azure/active-directory/develop/v2-oauth2-implicit-grant-flow), определенный в протоколе OAuth 2.0, и соответствует стандарту [OpenID](https://docs.microsoft.com/azure/active-directory/develop/v2-protocols-oidc).

Мы стремимся абстрагировать библиотеку от протокола, чтобы разработчики могли легко подключать проверку подлинности. Однако важно понимать устройство неявного потока с точки зрения безопасности.
Неявный поток выполняется в контексте веб-браузера, который не может безопасно управлять секретами клиента. Он оптимизирован для одностраничных приложений и имеет на один прыжок меньше между клиентом и сервером, поэтому маркеры возвращаются непосредственно в браузер. Поэтому его уровень безопасности естественным образом оказывается ниже.
Эти проблемы безопасности устраняются стандартными методами, например за счет использования кратковременных маркеров (в этом случае маркеры обновления не возвращаются), требования регистрировать URI перенаправления в библиотеке для приложения, сопоставления запроса и ответа в библиотеке с уникальным параметром nonce и state.

## <a name="cache-storage"></a>Хранилище кэша

Мы предлагаем два метода хранения для MSAL: `localStorage` и `sessionStorage`.  Рекомендуется использовать вариант `sessionStorage`, так как он обеспечивает более высокий уровень безопасности при хранении маркеров, полученных пользователями, однако способ `localStorage` обеспечивает единый вход для всех вкладок и пользовательских сеансов.  Мы рекомендуем вам изучить эти варианты и выбрать оптимальный для своего приложения.

### <a name="forcerefresh-to-skip-cache"></a>forceRefresh для пропуска кэша
Если вы не хотите использовать кэшированный маркер и получить его с сервера, передайте логическое значение `forceRefresh` в объект `AuthenticationParameters`, который используется для создания запроса на вход или получение маркера. **ПРЕДУПРЕЖДЕНИЕ.** По умолчанию использовать его не следует, так как в этом случае производительность приложения снижается.  Использование кэша повышает удобство работы пользователей и игнорировать его следует только тогда, когда доподлинно известно, что текущие кэшированные данные неактуальны.  Пример. Средство администрирования, добавляющее роли для пользователя, которому нужно получить новый маркер с обновленными ролями.

## <a name="usage"></a>Использование
В приведенном ниже примере подробно показано, как выполнить вход для пользователя и получить маркер, используемый для API Microsoft Graph.

#### <a name="prerequisites"></a>Предварительные требования

Перед использованием MSAL.js необходимо [зарегистрировать приложение в Azure AD](https://docs.microsoft.com/azure/active-directory/develop/quickstart-register-app), чтобы получить действительный `clientId` для настройки, а также зарегистрировать маршруты, по которым ваше приложение будет принимать трафик перенаправления.

#### <a name="1-instantiate-the-useragentapplication"></a>1. 1. Создание экземпляра UserAgentApplication

`UserAgentApplication` можно настроить с различными параметрами, подробно описанными на [вики-странице](https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki/MSAL.js-1.0.0-api-release#configuration-options), но единственным обязательным параметром является `auth.clientId`.

Если после создания экземпляра вы планируете использовать поток перенаправления в MSAL 1.2.x или более ранней версии (`loginRedirect` и `acquireTokenRedirect`), необходимо зарегистрировать обработчик обратного вызова с помощью `handleRedirectCallback(authCallback)`, где `authCallback = function(AuthError, AuthResponse)`. В MSAL 1.3.0 это необязательно. Функция обратного вызова вызывается после завершения или сбоя запроса проверки подлинности. Это не требуется для потоков всплывающих окон, так как они возвращают обещания.

```JavaScript
    import * as Msal from "msal";
    // if using cdn version, 'Msal' will be available in the global scope

    const msalConfig = {
        auth: {
            clientId: 'your_client_id'
        }
    };

    const msalInstance = new Msal.UserAgentApplication(msalConfig);

    msalInstance.handleRedirectCallback((error, response) => {
        // handle redirect response or error
    });

```

Дополнительные сведения о параметрах конфигурации см. в статье [Инициализация клиентских приложений с помощью MSAL.js](https://docs.microsoft.com/azure/active-directory/develop/msal-js-initializing-client-applications).

#### <a name="2-login-the-user"></a>2. 2. Вход пользователя

Приложение должно организовать вход пользователя в систему с помощью метода `loginPopup` или `loginRedirect`, чтобы определить контекст пользователя.

При вызове методов входа и проверки подлинности пользователя службой Azure AD возвращается [маркер идентификатора](https://docs.microsoft.com/azure/active-directory/develop/id-tokens), который используется для идентификации пользователя с указанием некоторых основных сведений.

При входе пользователя можно передать области, доступ к которым пользователь может предварительно разрешить при входе, однако это не обязательно. Обратите внимание, что согласие на доступ к областям при входе не возвращает access_token для этих областей, но дает возможность автоматически получить маркер с этими областями.

Рекомендуется запрашивать только те области, которые необходимы, и тогда, когда они необходимы. Такой подход называется "динамическим согласием". Это дает пользователям вашего приложения повышенную интерактивность при предоставлении согласия, а также сокращает отток пользователей, которых может не устраивать необходимость предоставлять множество разрешений для функций, которые они еще не используют.

AAD позволяет получать согласие только для трех ресурсов за раз, однако в одном ресурсе можно запросить множество областей.
Когда пользователь отправляет запрос на вход, вы можете передать несколько ресурсов и соответствующие области, так как AAD выдает idToken для получения предварительного согласия на доступ к этим областям. Однако вызовы acquireToken допустимы только для одного ресурса или нескольких областей. Если вам нужно получить доступ к нескольким ресурсам, выполните отдельный вызов acquireToken для каждого ресурса.

```JavaScript
   var loginRequest = {
       scopes: ["user.read", "mail.send"] // optional Array<string>
   };

    msalInstance.loginPopup(loginRequest)
        .then(response => {
            // handle response
        })
        .catch(err => {
            // handle error
        });

```

##### <a name="ssosilent"></a>ssoSilent

Если вы уверены, что у пользователя есть действующий сеанс, и хотите определить контекст пользователя без взаимодействия, можно вызвать метод `ssoSilent` с параметром `loginHint` или `sid` (доступен как [необязательное утверждение](https://docs.microsoft.com/azure/active-directory/develop/active-directory-optional-claims)), и MSAL попытается автоматически выполнить единый вход в существующий сеанс и определить контекст пользователя.

Обратите внимание, что при отсутствии активного сеанса для заданного параметра `loginHint` или `sid`возникает ошибка, которая должна обрабатываться путем вызова интерактивного метода входа (`loginPopup` или `loginRedirect`).

Пример.

```js
const ssoRequest = {
    loginHint: "user@example.com"
};

msalInstance.ssoSilent(ssoRequest)
    .then(response => {
        // session silently established
    })
    .catch(error => {
        // handle error by invoking an interactive login method
        msalInstance.loginPopup(ssoRequest);
    });
```

#### <a name="3-get-an-access-token-to-call-an-api"></a>3. Вызов API в маркере доступа

В MSAL можно получить маркеры доступа для API, которые вызывает приложение, с помощью метода `acquireTokenSilent`, который выполняет автоматический запрос (без участия пользователя) в Azure AD. После этого служба Azure AD возвращает [маркер доступа](https://docs.microsoft.com/azure/active-directory/develop/access-tokens), содержащий области, разрешенные пользователем, что позволяет приложению безопасно вызывать API.

Для запуска интерактивных запросов можно использовать методы `acquireTokenRedirect` или `acquireTokenPopup`, однако выводить интерактивный интерфейс рекомендуется, только если вы не можете получить маркер автоматически. При использовании интерактивного вызова маркера он должен соответствовать методу входа, используемому в приложении. (`loginPopup`=> `acquireTokenPopup`, `loginRedirect` => `acquireTokenRedirect`).

Если вызов `acquireTokenSilent` завершается сбоем с ошибкой типа `InteractionRequiredAuthError`, необходимо инициировать интерактивный запрос.  Это может произойти по многим причинам, в том числе из-за отозванных областей, просроченных маркеров или измененных паролей.

`acquireTokenSilent` ищет действительный маркер в кэше, и если он отсутствует или его срок действия истекает, метод автоматически попытается его обновить.

Дополнительные сведения см. в разделе [Типы данных запроса и ответа](https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki/MSAL.js-1.0.0-api-release#signing-in-and-getting-tokens-with-msaljs).

```JavaScript
    // if the user is already logged in you can acquire a token
    if (msalInstance.getAccount()) {
        var tokenRequest = {
            scopes: ["user.read", "mail.send"]
        };
        msalInstance.acquireTokenSilent(tokenRequest)
            .then(response => {
                // get access token from response
                // response.accessToken
            })
            .catch(err => {
                // could also check if err instance of InteractionRequiredAuthError if you can import the class.
                if (err.name === "InteractionRequiredAuthError") {
                    return msalInstance.acquireTokenPopup(tokenRequest)
                        .then(response => {
                            // get access token from response
                            // response.accessToken
                        })
                        .catch(err => {
                            // handle error
                        });
                }
            });
    } else {
        // user is not logged in, you will need to log them in to acquire a token
    }
```

#### <a name="4-use-the-token-as-a-bearer-in-an-http-request-to-call-the-microsoft-graph-or-a-web-api"></a>4. 4. Используйте маркер в качестве носителя в HTTP-запросе для вызова Microsoft Graph или веб-API.

```JavaScript
    var headers = new Headers();
    var bearer = "Bearer " + token;
    headers.append("Authorization", bearer);
    var options = {
         method: "GET",
         headers: headers
    };
    var graphEndpoint = "https://graph.microsoft.com/v1.0/me";

    fetch(graphEndpoint, options)
        .then(resp => {
             //do something with response
        });
```

Дополнительные сведения о функциональных возможностях MSAL.js см. на [вики-сайте MSAL](https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki) либо ознакомьтесь с полными [примерами кода](https://github.com/AzureAD/microsoft-authentication-library-for-js/wiki/Samples).

## <a name="security-reporting"></a>Отчеты по безопасности

Если вы обнаружите проблему безопасности с нашими библиотеками или службами, сообщите о ней на адрес [secure@microsoft.com](mailto:secure@microsoft.com), указав как можно больше подробностей. За это вы можете получить награду в рамках программы [Microsoft Bounty](http://aka.ms/bugbounty). Не публикуйте проблемы безопасности на GitHub или на других общедоступных сайтах. Мы свяжемся с вами вскоре после получения обращения. Рекомендуем вам настроить уведомления о нарушениях безопасности. Это можно сделать, подписавшись на уведомления безопасности консультационных служб на [этой странице](https://technet.microsoft.com/security/dd252948).

## <a name="license"></a>Лицензия

(c) Корпорация Майкрософт (Microsoft Corporation). Все права защищены  Все права защищены. Лицензировано в соответствии с лицензией MIT ("Лицензия").

## <a name="we-value-and-adhere-to-the-microsoft-open-source-code-of-conduct"></a>Мы соблюдаем Кодекс Майкрософт по обращению с ПО с открытым исходным кодом

В рамках этого проекта действуют [правила поведения в отношении продуктов с открытым исходным кодом Майкрософт](https://opensource.microsoft.com/codeofconduct/). Дополнительные сведения:[вопросы и ответы по правилам поведения](https://opensource.microsoft.com/codeofconduct/faq/). С любыми другими вопросами или комментариями обращайтесь по адресу[opencode@microsoft.com](mailto:opencode@microsoft.com).
